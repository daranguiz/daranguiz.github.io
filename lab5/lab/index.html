
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The course webpage of ECE 420 for Fall 2017">
      
      
      
      
        <link rel="shortcut icon" href="../../favicon.ico">
      
      <meta name="generator" content="mkdocs+mkdocs-material#1.0.1">
    
    
      
        <title>Lab 5 - Pitch Synthesis - ECE 420 - Fall 2017</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-facb31f4a3.js"></script>
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-e0a21a99ab.css">
      
      
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="ECE 420 - Fall 2017" class=" md-icon md-icon--home  md-header-nav__button">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Labs
                </span>
              
            
            Lab 5 - Pitch Synthesis
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            
          </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <i class=" md-icon md-icon--home  md-nav__button">
      
    </i>
    ECE 420 - Fall 2017
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  <li class="md-nav__item">
    
      <a href="../.." title="Home" class="md-nav__link">
        Home
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Prelabs
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-2">
        Prelabs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab2/prelab/" title="Prelab 2 - IIR Filtering" class="md-nav__link">
        Prelab 2 - IIR Filtering
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab3/prelab/" title="Prelab 3 - Fourier Transforms" class="md-nav__link">
        Prelab 3 - Fourier Transforms
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab4/prelab/" title="Prelab 4 - Autocorrelation" class="md-nav__link">
        Prelab 4 - Autocorrelation
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../prelab/" title="Prelab 5 - Resampling" class="md-nav__link">
        Prelab 5 - Resampling
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Labs
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-3">
        Labs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab1/lab/" title="Lab 1 - IMU Pedometer" class="md-nav__link">
        Lab 1 - IMU Pedometer
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab2/lab/" title="Lab 2 - Audio Filtering" class="md-nav__link">
        Lab 2 - Audio Filtering
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab3/lab/" title="Lab 3 - Spectrogram" class="md-nav__link">
        Lab 3 - Spectrogram
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab4/lab/" title="Lab 4 - Pitch Detection" class="md-nav__link">
        Lab 4 - Pitch Detection
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Lab 5 - Pitch Synthesis
      </label>
    
    <a href="./" title="Lab 5 - Pitch Synthesis" class="md-nav__link md-nav__link--active">
      Lab 5 - Pitch Synthesis
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloads" title="Downloads" class="md-nav__link">
    Downloads
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#td-psola" title="TD-PSOLA" class="md-nav__link">
    TD-PSOLA
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#source-filter-model-of-speech" title="Source-Filter Model of Speech" class="md-nav__link">
    Source-Filter Model of Speech
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#td-psola-explained" title="TD-PSOLA Explained" class="md-nav__link">
    TD-PSOLA Explained
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overlap-add-algorithm" title="Overlap-Add Algorithm" class="md-nav__link">
    Overlap-Add Algorithm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-manipulation" title="Buffer Manipulation" class="md-nav__link">
    Buffer Manipulation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buffer-manipulation-algorithm" title="Buffer Manipulation Algorithm" class="md-nav__link">
    Buffer Manipulation Algorithm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Resources
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-4">
        Resources
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../resources/python/" title="Python" class="md-nav__link">
        Python
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../resources/android/" title="Android" class="md-nav__link">
        Android
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloads" title="Downloads" class="md-nav__link">
    Downloads
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#td-psola" title="TD-PSOLA" class="md-nav__link">
    TD-PSOLA
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#source-filter-model-of-speech" title="Source-Filter Model of Speech" class="md-nav__link">
    Source-Filter Model of Speech
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#td-psola-explained" title="TD-PSOLA Explained" class="md-nav__link">
    TD-PSOLA Explained
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overlap-add-algorithm" title="Overlap-Add Algorithm" class="md-nav__link">
    Overlap-Add Algorithm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-manipulation" title="Buffer Manipulation" class="md-nav__link">
    Buffer Manipulation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buffer-manipulation-algorithm" title="Buffer Manipulation Algorithm" class="md-nav__link">
    Buffer Manipulation Algorithm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
              
                
                <h1 id="lab-5-pitch-synthesis">Lab 5 - Pitch Synthesis</h1>
<h3 id="summary">Summary</h3>
<p>In this lab, you will learn about a simplified model for human speech and how to exploit this model to shift the frequency of an incoming signal. You will also learn one method for producing continuous output within a batch processing framework.</p>
<h3 id="downloads">Downloads</h3>
<ul>
<li>Python test harness and test vector TBA</li>
<li>Android project source code TBA</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Some Remarks</p>
<p>We have completed the scaffolding of the TD-PSOLA algorithm for you, leaving remapping, windowing, and overlap-add for your lab assignment. You will be responsible for knowing why our buffering scheme guarantees smoothness in the signal reconstruction, and you will also be responsible for knowing why the characteristics of human speech permit such an algorithm.</p>
<p>We will try to explain these in detail in the lab notes, but please do not hesitate to ask your TA or ask on Piazza if these details are unclear. </p>
</div>
<h2 id="td-psola">TD-PSOLA</h2>
<p>Time-Domain Pitch Synchronous Overlap-Add, or TD-PSOLA, is the pitch-shifting algorithm we will be using in this lab. It relies heavily the source-filter model of speech, detailed below.</p>
<h3 id="source-filter-model-of-speech">Source-Filter Model of Speech</h3>
<p>We can model speech as the output of two successive blocks, a source block and filter block:</p>
<p><img alt="" src="../source_filter.png" /></p>
<p>Our vocal cords are the source, and we model the output of our vocal cords as a delta train (also called a Dirac comb). Of course, our vocal cords cannot truly produce zero-width impulses of energy, but this assumption is sufficient for modeling purposes. This series of impulses determines the fundamental frequency, or the pitch, of our utterance. </p>
<p>The impulses of energy produced by our vocal cords then travel up through our vocal tract. Everything in your vocal tract (lips, tongue throat, mouth cavity, nasal cavity, among others) affect the final waveform. We make the assumption that these effects are linear and can be combined without penalty, so we call everything inside the vocal tract the <em>filter</em>.</p>
<p>Simplifying the complex problem of speech generation in this manner allows us to apply some signal processing tools we learned in ECE 310. In particular, if we assume that speech is nothing but the output of a filter, we can rewrite speech in the form of a transfer function where <script type="math/tex">y(t)</script> is the utterance, <script type="math/tex">x(t)</script> is the source, and <script type="math/tex">h(t)</script> is the filter:</p>
<p>
<script type="math/tex; mode=display">
y(t) = x(t) * h(t)
</script>
</p>
<p>Note that <script type="math/tex">*</script> denotes the convolution operator. We can further rewrite <script type="math/tex">x(t)</script>, assuming <script type="math/tex">x(t)</script> is a delta train with some period <script type="math/tex">P</script>:</p>
<!--\[
y(t) = \left(\sum_{k=0}^\infty \delta(t - k P)\right) * h(t) = 
\sum_{k=0}^\infty \left( \delta(t - k P) * h(t) \right)

\]-->

<p>
<script type="math/tex; mode=display">
\begin{align}
    y(t) &= \left(\sum_{k=0}^\infty \delta(t - k P)\right) * h(t) \\
         &= \sum_{k=0}^\infty \delta(t - k P) * h(t) \\
         &= \sum_{k=0}^\infty h(t - k P)
\end{align}    
</script>
</p>
<p>This is a powerful result which says that the fundamental frequency (the pitch) does not depend on the filter <script type="math/tex">h(t)</script>, but on the source <script type="math/tex">x(t)</script>. In other words, speech can be decomposed into a sum of impulse responses, where the spacing of the impulse responses <script type="math/tex">P</script> determines the pitch. </p>
<p>If we want to shift the pitch, all we need is some way of identifying the impulse response from the speech signal. We can then extract the impulse response and place it with any spacing <script type="math/tex">P</script> in the synthesis signal we desire.</p>
<!-- TODO: generate image with delta train, impulse responses-->

<h3 id="td-psola-explained">TD-PSOLA Explained</h3>
<p>Considering the discussion above, we can rewrite our problem more formally. Given a signal <script type="math/tex">y_{P_0}(t)</script> with some fundamental period <script type="math/tex">P_0</script>:</p>
<p>
<script type="math/tex; mode=display">
y_{P_0}(t) = \sum_{k=0}^\infty h(t - k P_0),
</script>
</p>
<p>compute a new synthesis signal <script type="math/tex">y_{P_1}(t)</script> with a new period <script type="math/tex">P_1</script>:</p>
<p>
<script type="math/tex; mode=display">
\begin{align}
    y_{P_1}(t) &= \sum_{k=0}^\infty h(t - k P_1).
\end{align}
</script>
</p>
<p>In order to compute the new synthesis signal, we need some way of extracting the impulse response from <script type="math/tex">y_{P_0}(t)</script>. This is done by identifying the period (using the technique from Lab 4) and further identifying each <em>epoch</em> in the signal, or the location of each pitch period, by finding peaks in the signal approximately <script type="math/tex">P_0</script> samples apart. An example of this for a sample frame is shown below.</p>
<p><img alt="" src="../epoch_markings.png" /></p>
<p>We can then extract the impulse response (rather, an estimate of the impulse response) by windowing <script type="math/tex">\pm P_0</script> about each epoch marker. For example, when windowed with a Hanning window, an individual response may look like this:</p>
<p><img alt="" src="../windowed_impulse_response.png" /></p>
<p>Now that we have a method of estimating the impulse responses, we simply need to map from the original spacing <script type="math/tex">y_{P_0}(t) = \sum_{k=0}^\infty h(t - k P_0)</script> to the synthesis spacing <script type="math/tex">y_{P_1}(t) = \sum_{k=0}^\infty h(t - k P_1)</script>. In other words, we need to determine where the original impulse responses should go in our new signal.</p>
<p>Imagine our original signal has epochs spaced as below:</p>
<div class="codehilite"><pre><span></span><span class="n">orig</span><span class="o">:</span> <span class="mi">1</span>     <span class="mi">2</span>     <span class="mi">3</span>     <span class="mi">4</span>     <span class="mi">5</span>     <span class="mi">6</span>     <span class="mi">7</span>     <span class="mi">8</span>
</pre></div>


<p>and we want to double the frequency of the original signal without changing the duration. This can be achieved by spacing our new epochs at <script type="math/tex">P_1 = \frac{P_0}{2}</script>. For every new epoch at <script type="math/tex">\left\{ P_1, 2 P_1, 3 P_1, \dots \right\}</script>, we need to find the nearest epoch in the original signal. This mapping is shown below for our example signal:</p>
<div class="codehilite"><pre><span></span><span class="n">orig</span><span class="o">:</span> <span class="mi">1</span>     <span class="mi">2</span>     <span class="mi">3</span>     <span class="mi">4</span>     <span class="mi">5</span>     <span class="mi">6</span>     <span class="mi">7</span>     <span class="mi">8</span>
      <span class="o">|\</span>    <span class="o">|\</span>    <span class="o">|\</span>    <span class="o">|\</span>    <span class="o">|\</span>    <span class="o">|\</span>    <span class="o">|\</span>    <span class="o">|</span>
      <span class="o">|</span> <span class="o">\</span>   <span class="o">|</span> <span class="o">\</span>   <span class="o">|</span> <span class="o">\</span>   <span class="o">|</span> <span class="o">\</span>   <span class="o">|</span> <span class="o">\</span>   <span class="o">|</span> <span class="o">\</span>   <span class="o">|</span> <span class="o">\</span>   <span class="o">|</span>
<span class="k">new</span><span class="o">:</span>  <span class="mi">1</span>  <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">3</span>  <span class="mi">4</span>  <span class="mi">4</span>  <span class="mi">5</span>  <span class="mi">5</span>  <span class="mi">6</span>  <span class="mi">6</span>  <span class="mi">7</span>  <span class="mi">7</span>  <span class="mi">8</span>
</pre></div>


<p>The impulse responses in the <code>new</code> signal are combined by overlapping and adding their components. In Python, overlap and add is simply:</p>
<div class="codehilite"><pre><span></span><span class="n">original_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

<span class="c1"># Window, compute impulse response</span>
<span class="o">...</span> 

<span class="k">for</span> <span class="n">new_epoch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">P_1</span><span class="p">):</span>
    <span class="n">original_signal</span><span class="p">[</span><span class="n">new_epoch_idx</span> <span class="o">-</span> <span class="n">P_1</span><span class="p">:</span><span class="n">new_epoch_idx</span> <span class="o">+</span> <span class="n">P_1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">windowed_response</span>
</pre></div>


<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>The code above does not check if array indices are valid, so be careful.</p>
</div>
<p>Likewise, consider halving the frequency. This can be achieved with the following mapping:</p>
<div class="codehilite"><pre><span></span><span class="n">orig</span><span class="o">:</span> <span class="mi">1</span>     <span class="mi">2</span>     <span class="mi">3</span>     <span class="mi">4</span>     <span class="mi">5</span>     <span class="mi">6</span>     <span class="mi">7</span>     <span class="mi">8</span>
      <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>
      <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>
<span class="k">new</span><span class="o">:</span>  <span class="mi">1</span>           <span class="mi">3</span>           <span class="mi">5</span>           <span class="mi">7</span>
</pre></div>


<h4 id="overlap-add-algorithm">Overlap-Add Algorithm<a name='ola_algo'></a></h4>
<p>This can be extended further for any multiplier with the following algorithm:</p>
<ul>
<li>Compute the new period spacing <script type="math/tex">P_1 = \frac{F_s}{F_\text{new}}</script>
</li>
<li>For every new epoch at <script type="math/tex">i = \left\{P_1, 2 P_1, 3 P_1, \dots\right\}</script>:<ul>
<li>Find the closest epoch in the original signal</li>
<li>Approximate the impulse response by applying a Hanning window of length <script type="math/tex">2 P_0 + 1</script> centered at the original epoch</li>
<li>Overlap and add the windowed epoch into your new buffer centered at index <script type="math/tex">i</script>
</li>
</ul>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><a href="http://www.speech.zone/td-psola-the-hard-way/">This video on doing TD-PSOLA by hand</a> is very helpful for getting an intuitive understanding of TD-PSOLA. </p>
</div>
<h3 id="buffer-manipulation">Buffer Manipulation</h3>
<p>TD-PSOLA can be done on an arbitrarily long signal (as you will do in Python), but to run this algorithm in real-time, we need to use buffers. Our autocorrelation-based pitch detector requires at least 40 ms buffers, and we do not want to add any more delay than we have to, so let's keep 40 ms buffers. Our setup then is:</p>
<div class="codehilite"><pre><span></span>bufferIn:  &lt;-- 40 ms --&gt;

bufferOut: &lt;-- 40 ms --&gt;
</pre></div>


<p>Consider what happens if we do not do anything to ensure buffer continuity. Overlap-added Hanning windows do permit a perfect reconstruction (if we try to generate a synthesis signal with <script type="math/tex">P_0 = P_1</script>), but note what happens when we have a non-integer number of epochs in our original signal:</p>
<p><img alt="" src="../overlap_add_hannings.png" /></p>
<p>Everything beyond sample index 16 is perfectly reconstructed, but the samples prior are missing information for perfect reconstruction. If we do this across multiple buffers, we get a reconstruction waveform with clipping at the boundaries:</p>
<p><img alt="" src="../multiple_buffer_reconstruction_clipped.png" /></p>
<p>This problem does not come up when pitch shifting an entire .wav file, for example, because offline processing is allowed to be acausal. In other words, when doing this in Python, it is permissible to look into the future for your next epoch.</p>
<p>You cannot look into the future with online processing, but you can delay your buffer slightly to fake having access to past, present, and future data.</p>
<div class="codehilite"><pre><span></span>bufferIn:  | &lt;-- 20 ms past --&gt; | &lt;-- 20 ms present --&gt; | &lt;--     20 ms future     --&gt; |

bufferOut: | &lt;-- 20 ms past --&gt; | &lt;-- 20 ms present --&gt; | &lt;-- 20 ms future (zeros) --&gt; |
</pre></div>


<p>Every time we get a new 20 ms frame of data, we shift it into the <code>bufferIn</code> queue as in Lab 2. Delaying our <code>present</code> buffer by 20 ms, we can then look "into the future" for our epoch computation.</p>
<p>The trick is then how we deal with <code>bufferOut</code>. For the TD-PSOLA algorithm itself, we only compute new epochs for the <code>present</code> buffer. However, we let the <code>present</code> epochs spill over into the <code>past</code> and <code>future</code> buffers when doing overlap-add.</p>
<p>For example, say we have the following <code>bufferIn</code>, and we have epochs at <code>0, 2, 4, 6, 8, 10, 12, 14</code> with <code>P_0 = 1</code>. </p>
<div class="codehilite"><pre><span></span><span class="n">bufferIn</span><span class="o">:</span>  <span class="mi">0</span>   <span class="mi">1</span>   <span class="mi">2</span>   <span class="mi">3</span>   <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>   <span class="mi">9</span> <span class="o">|</span> <span class="mi">10</span>  <span class="mi">11</span>  <span class="mi">12</span>  <span class="mi">13</span>  <span class="mi">14</span>
</pre></div>


<p>If we want to perfectly reconstruct the signal, we can use the same epochs as in the original signal. Because we only compute <code>present</code> buffer epoch, we only compute overlap-add for epochs <code>6, 8</code>. Assume that this iteration had run before, and the <code>past</code> buffer is already computed. <code>(N)</code> denotes an incomplete reconstruction.</p>
<div class="codehilite"><pre><span></span><span class="n">bufferIn</span><span class="o">:</span>  <span class="mi">0</span>   <span class="mi">1</span>   <span class="mi">2</span>   <span class="mi">3</span>   <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>   <span class="mi">9</span> <span class="o">|</span> <span class="mi">10</span>  <span class="mi">11</span>  <span class="mi">12</span>  <span class="mi">13</span>  <span class="mi">14</span>

<span class="n">bufferOut</span><span class="o">:</span> <span class="mi">0</span>   <span class="mi">1</span>   <span class="mi">2</span>   <span class="mi">3</span>   <span class="mi">4</span> <span class="o">|(</span><span class="mi">5</span><span class="o">)</span>  <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">|</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>
                          <span class="o">+</span><span class="n">win</span><span class="o">(</span><span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span><span class="o">)</span>
                                  <span class="o">+</span><span class="n">win</span><span class="o">(</span><span class="mi">7</span>   <span class="mi">8</span>   <span class="mi">9</span><span class="o">)</span>
         <span class="o">=</span> <span class="mi">0</span>   <span class="mi">1</span>   <span class="mi">2</span>   <span class="mi">3</span>   <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>  <span class="o">(</span><span class="mi">9</span><span class="o">)|</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>
</pre></div>


<p>Notice how <code>6, 7, 8</code> are perfectly reconstructed, but <code>9</code> did not yet get enough information for complete reconstruction. Our <code>past</code> buffer is perfectly reconstructed, however, so we output that buffer to the speaker and shift our <code>bufferOut</code> accordingly. In the next iteration, we have the following buffer configuration:</p>
<div class="codehilite"><pre><span></span><span class="n">bufferIn</span><span class="o">:</span>  <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>   <span class="mi">9</span> <span class="o">|</span> <span class="mi">10</span>  <span class="mi">11</span>  <span class="mi">12</span>  <span class="mi">13</span>  <span class="mi">14</span><span class="o">|</span> <span class="mi">15</span>  <span class="mi">16</span>  <span class="mi">17</span>  <span class="mi">18</span>  <span class="mi">19</span>

<span class="n">bufferOut</span><span class="o">:</span> <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>  <span class="o">(</span><span class="mi">9</span><span class="o">)|</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">|</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>
</pre></div>


<p>Trying to reconstruct the <code>present</code> buffer again, we have the following:</p>
<div class="codehilite"><pre><span></span><span class="n">bufferIn</span><span class="o">:</span>  <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>   <span class="mi">9</span> <span class="o">|</span> <span class="mi">10</span>  <span class="mi">11</span>  <span class="mi">12</span>  <span class="mi">13</span>  <span class="mi">14</span><span class="o">|</span> <span class="mi">15</span>  <span class="mi">16</span>  <span class="mi">17</span>  <span class="mi">18</span>  <span class="mi">19</span>

<span class="n">bufferOut</span><span class="o">:</span> <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>  <span class="o">(</span><span class="mi">9</span><span class="o">)|</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">|</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>
                      <span class="o">+</span><span class="n">win</span><span class="o">(</span><span class="mi">9</span>   <span class="mi">10</span>  <span class="mi">11</span><span class="o">)</span>
                              <span class="o">+</span><span class="n">win</span><span class="o">(</span><span class="mi">11</span>  <span class="mi">12</span>  <span class="mi">13</span><span class="o">)</span>
                                      <span class="o">+</span><span class="n">win</span><span class="o">(</span><span class="mi">13</span>  <span class="mi">14</span>  <span class="mi">15</span><span class="o">)</span>
         <span class="o">=</span> <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>   <span class="mi">9</span> <span class="o">|</span> <span class="mi">10</span>  <span class="mi">11</span>  <span class="mi">12</span>  <span class="mi">13</span>  <span class="mi">14</span><span class="o">|(</span><span class="mi">15</span><span class="o">)</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>
</pre></div>


<p>By allowing our <code>present</code> computation to spill over into the <code>past</code> and <code>future</code> buffers, we can guarantee that by the end of your <code>present</code> computation, the <code>past</code> buffer will be fully reconstructed. </p>
<h4 id="buffer-manipulation-algorithm">Buffer Manipulation Algorithm</h4>
<p>To implement this practically, the algorithm is as follows. Let <code>FRAME_SIZE</code> be the number of samples for each 20 ms section, and let <code>i</code> point to your new epoch positions.</p>
<ul>
<li>Initialize <code>i = FRAME_SIZE</code> so it points at the first index of the <code>present</code> section of <code>bufferOut</code>. Only do this in the first iteration.</li>
<li>While <code>i &lt; 2 * FRAME_SIZE</code>, or while <code>i</code> is inside <code>present</code>:<ul>
<li>Compute the <a href="#ola_algo">overlap-add algorithm detailed above</a></li>
<li>Increment <code>i</code> such that <code>i += P_1</code></li>
</ul>
</li>
<li>Decrement <code>i</code> such that <code>i -= FRAME_SIZE</code></li>
</ul>
<p>Letting <code>i</code> spill over into the <code>future</code> buffer (which is what happens in the last iteration of the while loop), we maintain a pointer to where the first epoch of the next frame should go. Decrementing by <code>FRAME_SIZE</code> ensures continuity after shifting your <code>past</code> buffer out to the speaker.</p>
<div class="admonition tip">
<p class="admonition-title">Note</p>
<p>Your TA will go over this in more detail at the beginning of your lab section. <a href="http://pre12.deviantart.net/4441/th/pre/f/2011/311/1/b/don__t_panic_wallpaper_by_vantaj-d4fgo87.jpg">Don't panic!</a></p>
<!--TODO: don't panic, host locally-->

</div>
<!--## Python

## Grading

Your lab will be graded as follows:

* Prelab (2 points) 
* Lab (4 points) 
* Quiz (2 points) -->
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../lab4/lab/" title="Lab 4 - Pitch Detection" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Lab 4 - Pitch Detection
              </span>
            </div>
          </a>
        
        
          <a href="../../resources/python/" title="Python" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Python
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-16f434a21a.js"></script>
      <script>var config={url:{base:"../.."}},app=new Application(config);app.initialize()</script>
      
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
    
      
    
  </body>
</html>