
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The course webpage of ECE 420 for Fall 2017">
      
      
      
      
        <link rel="shortcut icon" href="../../favicon.ico">
      
      <meta name="generator" content="mkdocs+mkdocs-material#1.0.1">
    
    
      
        <title>Lab 2 - Audio Filtering - ECE 420 - Fall 2017</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-facb31f4a3.js"></script>
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-e0a21a99ab.css">
      
      
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="ECE 420 - Fall 2017" class=" md-icon md-icon--home  md-header-nav__button">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Labs
                </span>
              
            
            Lab 2 - Audio Filtering
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            
          </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <i class=" md-icon md-icon--home  md-nav__button">
      
    </i>
    ECE 420 - Fall 2017
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  <li class="md-nav__item">
    
      <a href="../.." title="Home" class="md-nav__link">
        Home
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Prelabs
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-2">
        Prelabs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../prelab/" title="Prelab 2 - IIR Filtering" class="md-nav__link">
        Prelab 2 - IIR Filtering
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab3/prelab/" title="Prelab 3 - Fourier Transforms" class="md-nav__link">
        Prelab 3 - Fourier Transforms
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab4/prelab/" title="Prelab 4 - Autocorrelation" class="md-nav__link">
        Prelab 4 - Autocorrelation
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab5/prelab/" title="Prelab 5 - Resampling" class="md-nav__link">
        Prelab 5 - Resampling
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Labs
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-3">
        Labs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab1/lab/" title="Lab 1 - IMU Pedometer" class="md-nav__link">
        Lab 1 - IMU Pedometer
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Lab 2 - Audio Filtering
      </label>
    
    <a href="./" title="Lab 2 - Audio Filtering" class="md-nav__link md-nav__link--active">
      Lab 2 - Audio Filtering
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloads" title="Downloads" class="md-nav__link">
    Downloads
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python" title="Python" class="md-nav__link">
    Python
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-1-filter-generation" title="Part 1 - Filter Generation" class="md-nav__link">
    Part 1 - Filter Generation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-2-fir-filter" title="Part 2 - FIR Filter" class="md-nav__link">
    Part 2 - FIR Filter
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android" title="Android" class="md-nav__link">
    Android
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-3-opensl-es" title="Part 3 - OpenSL ES" class="md-nav__link">
    Part 3 - OpenSL ES
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background" title="Background" class="md-nav__link">
    Background
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-structure" title="Code Structure" class="md-nav__link">
    Code Structure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-4-pcm-16-decoding" title="Part 4 - PCM-16 Decoding" class="md-nav__link">
    Part 4 - PCM-16 Decoding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-5-fir-filter" title="Part 5 - FIR Filter" class="md-nav__link">
    Part 5 - FIR Filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-6-iir-filter-extra-credit" title="Part 6 - IIR Filter (Extra Credit)" class="md-nav__link">
    Part 6 - IIR Filter (Extra Credit)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grading" title="Grading" class="md-nav__link">
    Grading
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab3/lab/" title="Lab 3 - Spectrogram" class="md-nav__link">
        Lab 3 - Spectrogram
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab4/lab/" title="Lab 4 - Pitch Detection" class="md-nav__link">
        Lab 4 - Pitch Detection
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../lab5/lab/" title="Lab 5 - Pitch Synthesis" class="md-nav__link">
        Lab 5 - Pitch Synthesis
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Resources
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-4">
        Resources
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../resources/python/" title="Python" class="md-nav__link">
        Python
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../resources/android/" title="Android" class="md-nav__link">
        Android
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloads" title="Downloads" class="md-nav__link">
    Downloads
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python" title="Python" class="md-nav__link">
    Python
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-1-filter-generation" title="Part 1 - Filter Generation" class="md-nav__link">
    Part 1 - Filter Generation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-2-fir-filter" title="Part 2 - FIR Filter" class="md-nav__link">
    Part 2 - FIR Filter
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android" title="Android" class="md-nav__link">
    Android
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-3-opensl-es" title="Part 3 - OpenSL ES" class="md-nav__link">
    Part 3 - OpenSL ES
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background" title="Background" class="md-nav__link">
    Background
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-structure" title="Code Structure" class="md-nav__link">
    Code Structure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-4-pcm-16-decoding" title="Part 4 - PCM-16 Decoding" class="md-nav__link">
    Part 4 - PCM-16 Decoding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-5-fir-filter" title="Part 5 - FIR Filter" class="md-nav__link">
    Part 5 - FIR Filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-6-iir-filter-extra-credit" title="Part 6 - IIR Filter (Extra Credit)" class="md-nav__link">
    Part 6 - IIR Filter (Extra Credit)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grading" title="Grading" class="md-nav__link">
    Grading
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
              
                
                <h1 id="lab-2-audio-filtering">Lab 2 - Audio Filtering</h1>
<h3 id="summary">Summary</h3>
<p>In this lab, you will learn how to design FIR notch filters to specification using Python and how to implement filters efficiently in Android.</p>
<h3 id="downloads">Downloads</h3>
<p><a href="../ece420_lab2.zip">Android Project source code</a></p>
<h2 id="python">Python</h2>
<!--Content to come. Basics will be as follows:

* Generate an FIR notch filter
* How many taps do you need to effectively implement this? Considerations include sharpness of the transition band, sampling rate, width of the passband, width of the stopband 
* Generate an IIR notch filter. 
* How does the IIR notch filter compare to the FIR filter? What are the pro's? What are the con's? -->

<h3 id="part-1-filter-generation">Part 1 - Filter Generation</h3>
<p>Filter design in Python is very similar to filter design in MATLAB. SciPy has a <a href="https://docs.scipy.org/doc/scipy/reference/signal.html">Signal Processing library</a> that contains built-in code for convolution, spline interpolation, filtering and filter design, as well as other signal analysis. If you are looking for a DSP function that exists in MATLAB, this library should be the first place you check.</p>
<p>In particular, we will be looking at <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.firls.html#scipy.signal.firls">scipy.signal.firls</a> for our FIR filter design. Your task will be to generate the coefficients for a bandstop filter with the given specifications:</p>
<ul>
<li>Frequencies between 1KHz and 2KHz should be attenuated to approximately -20dB or less.</li>
<li>All other frequencies should pass through with approximately unity gain.</li>
<li>Assume a sampling rate of 48kHz.</li>
</ul>
<p>Our final goal with this filter will be to allow speech through with no attenuation but suppress pure sine tones between 1KHz and 2KHz. Some things to think about:</p>
<ol>
<li>You can design any filter if you allow the filter order to go to infinity. What are the practical considerations to using a longer filter?</li>
<li>The sharper the transition bands, the larger the ripple in the passband. We've defined a relatively narrow stopband. How wide can you make the transition bands while still meeting your application's requirements?</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Assignment</p>
<p>Generate an FIR filter using <code>scipy.signal.firls()</code>. Sample code start you off and display the frequency response is given below.</p>
<p>Show your TA when your filter design is done. Defend your design decisions regarding points 1 and 2 from above. </p>
</div>
<p>Skeleton Python code shown below. Feel free to modify it as you see fit. </p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>

<span class="c1"># Your filter design here</span>
<span class="c1"># firls() can be called via signal.firls()</span>
<span class="n">b</span> <span class="o">=</span> <span class="err">??</span>

<span class="c1"># Signal analysis</span>
<span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">freqz</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Digital filter frequency response, N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)),</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude [dB]&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Angle (radians)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [0 to Nyquist Hz, normalized]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<h3 id="part-2-fir-filter">Part 2 - FIR Filter</h3>
<p>Now that you have your filter coefficients, you will implement your filter in Python and test it on sample data. This prototyping stage is to get you comfortable with actually using a filter before implementing it on Android, which is significantly more difficult to debug. Your filtering code should only be a few lines long. Do not use any <code>scipy.signal</code> functions such as <code>lfilt</code> to compute the filtered output. </p>
<div class="admonition note">
<p class="admonition-title">Assignment</p>
<p>Implement the filter designed in Part 1. Test your filter on the time_domain signal <code>test_data</code> given below and plot the time domain result.</p>
<p>Show your TA when you are done.</p>
</div>
<p>Python test code:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span> 
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span> 

<span class="n">F_s</span> <span class="o">=</span> <span class="mi">48000</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">F_s</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F_s</span><span class="p">)]</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">chirp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">24000</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;logarithmic&#39;</span><span class="p">)</span>

<span class="c1"># ... filter ...</span>
</pre></div>


<p>The following code may be used to convert a Python array of coefficients to a static C++ array initialization:</p>
<div class="codehilite"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

<span class="n">coef_str</span> <span class="o">=</span> <span class="s2">&quot;float coefs[] = {&quot;</span>

<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
    <span class="n">coef_str</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span>

<span class="n">coef_str</span> <span class="o">=</span> <span class="n">coef_str</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">coef_str</span> <span class="o">+=</span> <span class="s2">&quot;};&quot;</span>

<span class="k">print</span><span class="p">(</span><span class="n">coef_str</span><span class="p">)</span>
</pre></div>


<h2 id="android">Android</h2>
<h3 id="part-3-opensl-es">Part 3 - OpenSL ES</h3>
<h4 id="background">Background</h4>
<p>If you've worked with Android before, you may wonder why we're using the NDK for our audio transactions. An example of Java's audio recording callflow taken from <a href="http://stackoverflow.com/questions/8499042/android-audiorecord-example">this StackOverflow post</a> is given below:</p>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startRecording</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">recorder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AudioRecord</span><span class="o">(</span><span class="n">MediaRecorder</span><span class="o">.</span><span class="na">AudioSource</span><span class="o">.</span><span class="na">MIC</span><span class="o">,</span>
            <span class="n">RECORDER_SAMPLERATE</span><span class="o">,</span> <span class="n">RECORDER_CHANNELS</span><span class="o">,</span>
            <span class="n">RECORDER_AUDIO_ENCODING</span><span class="o">,</span> <span class="n">BufferElements2Rec</span> <span class="o">*</span> <span class="n">BytesPerElement</span><span class="o">);</span>

    <span class="n">recorder</span><span class="o">.</span><span class="na">startRecording</span><span class="o">();</span>
    <span class="n">isRecording</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">recordingThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">writeAudioDataToFile</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="s">&quot;AudioRecorder Thread&quot;</span><span class="o">);</span>
    <span class="n">recordingThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<p>In the code above, we first initialize a new <code>AudioRecord</code> instance containing all of our recording parameters, such as sampling rate, mono or stereo, encoding format, and number of elements in the audio buffer. We tell the <code>AudioRecord</code> instance to begin sampling the microphone and storing data in the buffer, then we launch a thread to monitor the buffer and extract samples when it is full (not shown). </p>
<p>The problem with this approach is the <em>latency</em>. Android has a longstanding problem implementing <a href="https://www.youtube.com/watch?v=Curn_fdMOBA">low-latency audio solutions compared to iOS</a>. As of Q1 2015, this was reflected in the <a href="http://superpowered.com/androidaudiopathlatency">disproportionate number of music apps available for Android versus iOS</a>. At a high level, Android requires large sampling buffers to be filled before the data can be read. Compare this to the last lab -- it would be as if you could only read sensor data every <code>N</code> samples versus every sample. For the Java implementation given above, the minimum recording and playback buffer sizes result in about 200ms round-trip delay (RTD).</p>
<p>Android has made great strides in low-latency audio in the last few years, however. They have introduced a <a href="https://developer.android.com/ndk/guides/audio/index.html">low-latency pipeline accessible in the NDK</a> that operates on the <a href="https://www.khronos.org/opensles/">OpenSL ES framework</a>, a standardized embedded audio API. If you use the device's default sampling rate and buffer size, it will utilize the <a href="https://source.android.com/devices/audio/latency_design.html#fastMixer">Fast Mixer</a> thread.</p>
<p>Use of the Android Fast Audio Path is taken care of for you in this lab, but the idea of tradeoffs between latency and buffer size is a fundamental concept in embedded audio.</p>
<div class="admonition tip">
<p class="admonition-title">Note</p>
<p>If this is a topic that interests you, there's a <a href="https://www.youtube.com/watch?v=92fgcUNCHic">~45 minute Google I/O talk</a> that discusses the changes they've made in the last couple years to bring their latency down.</p>
</div>
<h4 id="code-structure">Code Structure</h4>
<p>All of your audio labs will be based on Android's <a href="https://github.com/googlesamples/android-ndk/tree/master/audio-echo">Audio-Echo NDK sample</a>. The Java side of this application should look similar to Lab 1, except instead of your <code>button.onClickListener()</code> being defined programmatically during <code>onCreate()</code>, it is defined in <code>app/res/layout/activity_main.xml</code> directly as below:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;Button</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/button_start_capture&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:text=</span><span class="s">&quot;@string/StartEcho&quot;</span>
    <span class="na">android:onClick=</span><span class="s">&quot;startEcho&quot;</span> <span class="nt">/&gt;</span>
</pre></div>


<p>Notice the field <code>android:onClick="startEcho"</code>. This says that when the <code>Start</code> button is clicked, the function <code>startEcho()</code> in <code>MainActivity.java</code> is called. Likewise, the same goes for <code>stopEcho()</code>. The most significant change between Lab 1 and Lab 2 is the introduction of the NDK. If you scroll to the bottom of <code>MainActivity.java</code>, you will see a host of unimplemented functions:</p>
<div class="codehilite"><pre><span></span><span class="cm">/*</span>
<span class="cm">* jni function implementations...</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">createSLEngine</span><span class="o">(</span><span class="kt">int</span> <span class="n">rate</span><span class="o">,</span> <span class="kt">int</span> <span class="n">framesPerBuf</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">deleteSLEngine</span><span class="o">();</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">createSLBufferQueueAudioPlayer</span><span class="o">();</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">deleteSLBufferQueueAudioPlayer</span><span class="o">();</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">createAudioRecorder</span><span class="o">();</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">deleteAudioRecorder</span><span class="o">();</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">startPlay</span><span class="o">();</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">stopPlay</span><span class="o">();</span>
</pre></div>


<p>These functions are defined through JNI, the Java Native Interface. The JNI provides a nice way for Java to interact with functions defined in C++ using the NDK. Without going into specifics, let's take a look at what these function declarations look like in C++. Open the file <code>app/cpp/audio_main.cpp</code> and scroll to line 50:</p>
<div class="codehilite"><pre><span></span><span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span>
<span class="nf">Java_com_ece420_lab2_MainActivity_createSLEngine</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">jint</span><span class="p">,</span> <span class="n">jint</span><span class="p">);</span>
</pre></div>


<p>Here we have the other side of the JNI. The function arguments contain two pointers referring back to the Java environment, then our two expected <code>int</code> arguments. </p>
<div class="admonition tip">
<p class="admonition-title">Note</p>
<p>You shouldn't have to modify any of the JNI-specific code. This is provided for reference.</p>
</div>
<p>Your responsibility will be to fill in the function <code>ece420ProcessFrame(sample_buf *dataBuf)</code> in <code>ece420_main.cpp</code>, which gets called every time the the microphone fills its <code>N</code>-sample buffer. This has the same effect as the Digital Filter block in the image below:</p>
<p><img alt="Classical DSP pipeline" src="../../420embedded.png" /></p>
<p>On completion of <code>ece420ProcessFrame()</code>, anything inside <code>dataBuf</code> will be written out to the speaker (the D/A) and played. You will have to process the incoming audio data in <code>dataBuf</code> and overwrite the old data with your processed data to play your filtered audio. </p>
<h3 id="part-4-pcm-16-decoding">Part 4 - PCM-16 Decoding</h3>
<p>Your audio data will come from OpenSL as a buffer of 128 PCM-16 encoded samples. From <a href="https://en.wikipedia.org/wiki/Pulse-code_modulation">Wikipedia</a>: </p>
<blockquote>
<p>Pulse-code modulation (PCM) is a method used to digitally represent sampled analog signals. It is the standard form of digital audio in computers, compact discs, digital telephony and other digital audio applications. In a PCM stream, the amplitude of the analog signal is sampled regularly at uniform intervals, and each sample is quantized to the nearest value within a range of digital steps.</p>
</blockquote>
<p>Your first task in Android will be to decode this data into usable <code>int16_t</code> data and then back to byte-packed data. If you view the declaration for <code>sample_buf</code> (right click -&gt; <code>Go To</code> -&gt; <code>Declaration</code>), you can see that <code>sample_buf</code> consists of the following: </p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">sample_buf</span> <span class="p">{</span>
    <span class="kt">uint8_t</span>    <span class="o">*</span><span class="n">buf_</span><span class="p">;</span>       <span class="c1">// audio sample container</span>
    <span class="kt">uint32_t</span>    <span class="n">cap_</span><span class="p">;</span>       <span class="c1">// buffer capacity in byte</span>
    <span class="kt">uint32_t</span>    <span class="n">size_</span><span class="p">;</span>      <span class="c1">// audio sample size (n buf) in byte</span>
<span class="p">};</span>
</pre></div>


<p>The data is stored as as a <code>uint8_t</code> array of size <code>2*N</code>. OpenSL uses <a href="https://www.cs.umd.edu/class/sum2003/cmsc311/Notes/Data/endian.html">little endian</a> byte order, meaning that the least significant byte is stored in the lower index of the array. </p>
<div class="admonition note">
<p class="admonition-title">Assignment</p>
<p>Convert the PCM-16 data in <code>dataBuf</code> to <code>int16_t</code> and write the output to <code>bufferIn</code>. Also convert <code>bufferOut</code> to PCM-16 data and write the output back into <code>dataBuf</code> for the OpenSL player to read.</p>
<p>You can verify that your conversion is correct by placing a breakpoint at the end of <code>ece420ProcessFrame()</code> and comparing the byte values in <code>buf_</code> to the values in your <code>int16_t</code> array as below. Keep in mind that these values can be negative. </p>
<p><img alt="Android dataBuf debugging" src="../android_databuf_debug.png" /></p>
<p>To view the buffer byte values in <code>hex</code> instead of <code>char</code>, type the following in the LLDB tab in your debugging window:</p>
<p><code>(lldb) type format add -f x uint8_t</code></p>
</div>
<h3 id="part-5-fir-filter">Part 5 - FIR Filter</h3>
<p>Now that you have usable data in the form of <code>int16_t</code>, you will implement the FIR filter you designed earlier in Python. For the sake of performance, you will be using a fixed-sized array to hold the past-sample buffer required for an FIR filter such as  </p>
<p>
<script type="math/tex; mode=display">
y[n] = a x[n] + b x[n-1] + c x[n-2] + \dots
</script>
</p>
<p>The most efficient way to manage a fixed-sized array is using a circular buffer. Circular buffers maintain an index of the most recent sample and insert new data at <code>mod(idx + 1, N)</code>, where <code>N</code> is the length of your array. For a length 5 array, successive data input would look as follows:</p>
<div class="codehilite"><pre><span></span>n = 0: {0, 1, 2, 3, 4}
n = 1: {5, 1, 2, 3, 4}
n = 2: {5, 6, 2, 3, 4}
n = 3: {5, 6, 7, 3, 4}
n = 4: {5, 6, 7, 8, 4}
n = 5: {5, 6, 7, 8, 9}
</pre></div>


<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You may not use <code>bufferIn</code> directly to access prior samples for <script type="math/tex"> x[n-1], x[n-2], </script> etc. This constraint will be lifted in the next lab when we begin discussing batch processing, but for now, we will avoid the boundary issues that arise when doing frame-by-frame processing. </p>
</div>
<p>Code that emulates sample-by-sample processing is given in the source code and replicated below:</p>
<div class="codehilite"><pre><span></span><span class="c1">// Loop code provided as a suggestion. </span>
<span class="c1">// This loop simulates sample-by-sample processing.</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sampleIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sampleIdx</span> <span class="o">&lt;</span> <span class="n">dataBuf</span><span class="o">-&gt;</span><span class="n">size_</span><span class="p">;</span> <span class="n">sampleIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">sample</span> <span class="o">=</span> <span class="n">bufferIn</span><span class="p">[</span><span class="n">sampleIdx</span><span class="p">];</span>

    <span class="c1">// Your function implementation</span>
    <span class="kt">int16_t</span> <span class="n">output</span> <span class="o">=</span> <span class="n">firFilter</span><span class="p">(</span><span class="n">sample</span><span class="p">);</span>

    <span class="n">bufferOut</span><span class="p">[</span><span class="n">sampleIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<!--Your filter coefficients from earlier should be designed such that the output has unity gain. This is particularly important when working on 16-bit data, as `int16_t` can only represent values between -32,678 and 32,767. Care must be taken that intermediate filter computations don't cause integer overflow as in the following code:

``` c++
int16_t a = 32767;
int16_t b = 1;
int16_t c = a + b;

// c = -32768
```-->

<div class="admonition note">
<p class="admonition-title">Assignment</p>
<p>Implement the function <code>int16_t firFilter(int16_t sample)</code> to process data on a sample-by-sample basis. Sample history must be maintained using a circular buffer <em>or</em> some other Queue implementation. </p>
<p>The final result should be a real-time notch filter that listens over the microphone and attenuates frequencies around 1KHz, outputting the filtered data over the speakers. You can verify your results by playing a sine sweep into your tablet's microphone and listening to see if frequencies around 1KHz are attenuated.</p>
</div>
<h3 id="part-6-iir-filter-extra-credit">Part 6 - IIR Filter (Extra Credit)</h3>
<p>For 1 point of extra credit, design and implement an IIR filter in Android that meets the same specifications as your FIR filter. </p>
<h2 id="grading">Grading</h2>
<p>Your lab will be graded as follows:</p>
<ul>
<li>Prelab (2 points)</li>
<li>Lab (4 points)</li>
<li>Quiz (2 points)</li>
<li>Extra credit (+1 point)</li>
</ul>
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../lab1/lab/" title="Lab 1 - IMU Pedometer" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Lab 1 - IMU Pedometer
              </span>
            </div>
          </a>
        
        
          <a href="../../lab3/lab/" title="Lab 3 - Spectrogram" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Lab 3 - Spectrogram
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-16f434a21a.js"></script>
      <script>var config={url:{base:"../.."}},app=new Application(config);app.initialize()</script>
      
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
    
      
    
  </body>
</html>